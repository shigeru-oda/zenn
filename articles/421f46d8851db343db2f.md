---
title: "ã€Network Firewallã€‘AWSã®åŸºç¤ã‚’å­¦ã¼ã† ç‰¹åˆ¥ç·¨ã€€æœ€æ–°ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã¿ã‚“ãªã§è§¦ã£ã¦ã¿ã‚‹"
emoji: "ğŸš´ğŸ»â€â™€ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws","åº§å­¦","æ„Ÿæƒ³"]
published: true
---
# æ¦‚è¦
ã€ŒAWS ã‚¨ãƒãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã‚·ãƒªãƒ¼ã‚ºã€€AWSã®åŸºç¤ã‚’å­¦ã¼ã†ã€ã§â€AWSã®åŸºç¤ã‚’å­¦ã¼ã† ç‰¹åˆ¥ç·¨ã€€æœ€æ–°ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã¿ã‚“ãªã§è§¦ã£ã¦ã¿ã‚‹ Network Firewallâ€ã¨ã„ã†ã‚¤ãƒ™ãƒ³ãƒˆã«å‚åŠ ã—ãŸæ„Ÿæƒ³ãƒšãƒ¼ã‚¸ã§ã™ã€‚

# ã€ŒAWS ã‚¨ãƒãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã‚·ãƒªãƒ¼ã‚ºã€€AWSã®åŸºç¤ã‚’å­¦ã¼ã†ã€ã¨ã¯
[AWS ã‚¨ãƒãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã‚·ãƒªãƒ¼ã‚ºã€€AWSã®åŸºç¤ã‚’å­¦ã¼ã†](https://awsbasics.connpass.com)

ä»¥ä¸‹ã€Connpassãƒšãƒ¼ã‚¸ã‚ˆã‚Šå¼•ç”¨

>  Amazon Web Services (AWS)ã¯ç¾åœ¨200ã‚’è¶…ãˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ã€æ—¥ã€…ã‚µãƒ¼ãƒ“ã‚¹ã®æ‹¡å……ã‚’ç¶šã‘ã¦ã„ã¾ã™ã€‚
> ã“ã®AWS ã‚¨ãƒãƒ³ãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã‚·ãƒªãƒ¼ã‚ºã§ã¯é€±æ¬¡ã§AWSã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã²ã¨ã¤ã¥ã¤å–ã‚Šä¸Šã’ãªãŒã‚‰ãã®åŸºç¤ã‚’èª¬æ˜ã—ã¦ã„ã åˆå¿ƒè€…ã€ä¸­ç´šè€…ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã—ãŸè¬›åº§ã§ã™ã€‚åˆå¾Œã®ä»•äº‹å‰ã«ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã‚’ä¸€ç·’ã«ã—ã¾ã›ã‚“ã‹ï¼Ÿ
> æ³¨æ„ç‚¹ ç™»å£‡è€…ã«ã‚ˆã‚‹ç™ºè¡¨å†…å®¹ã¯ã‚¢ãƒã‚¾ãƒ³ ã‚¦ã‚§ãƒ– ã‚µãƒ¼ãƒ“ã‚¹ ã‚¸ãƒ£ãƒ‘ãƒ³ã¨ã—ã¦ä¸»å‚¬ã—ã¦ã„ã‚‹ã‚‚ã®ã§ã¯ãªãã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ´»å‹•ã®ä¸€ç’°ã¨ã—ã¦å‹‰å¼·ä¼šã®ä¸»å‚¬ã‚’è¡Œã£ã¦ã„ã‚‹ã‚‚ã®ã§ã™ã€‚

æ¯é€±ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

# å†…å®¹
éå»ã«NetworkFirewallã®ãƒ–ãƒ­ã‚°ã¯ä½•å€‹ã‹è¨˜è¼‰ã—ã¦ã¾ã™ã®ã§ã€ãƒ«ãƒ¼ãƒ«ã«ã¤ã„ã¦è¨˜è¼‰ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## Network Firewallã®ãƒ«ãƒ¼ãƒ«
![](https://storage.googleapis.com/zenn-user-upload/db294945c18dda2ca4b7b53e.png)
- ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ã«å¯¾ã™ã‚‹ãƒ«ãƒ¼ãƒ«ãŒè©•ä¾¡ã•ã‚Œã‚‹
  - pass
  - drop
  - ä¸Šè¨˜ä»¥å¤–ã®å ´åˆã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ã«å¯¾ã™ã‚‹ãƒ«ãƒ¼ãƒ«ãŒè©•ä¾¡ã•ã‚Œã‚‹
- ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ã«å¯¾ã™ã‚‹ãƒ«ãƒ¼ãƒ«ãŒè©•ä¾¡ã•ã‚Œã‚‹
  - pass(+ alert)
  - drop(+ alert)

ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ã¯é›£ã—ã„ã®ã§ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ã§ä»¥ä¸‹ã¯è¨­å®šã—ã¾ã™ã€‚
## ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£
![](https://storage.googleapis.com/zenn-user-upload/bad9ae91ffc181f946bb5bc9.png)
### ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ã£ã¦ãªã«ï¼Ÿ
>ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ãƒ«ãƒ¼ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ã«å¿…è¦ãªæœ€å¤§å‡¦ç†ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ãƒ¼ã‚’æŒ‡å®šã—ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ãƒãƒªã‚·ãƒ¼ã‹ã‚‰ãƒ«ãƒ¼ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‚ç…§ã™ã‚‹å ´åˆã€ã“ã®ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ãƒ¼ã¯ãƒãƒªã‚·ãƒ¼ã®ãƒ«ãƒ¼ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ç”¨ã«äºˆç´„ã•ã‚Œã¾ã™ã€‚ãƒ«ãƒ¼ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ã®æ›´æ–°æ™‚ã«ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ãƒ¼ã‚’å¤‰æ›´ã¾ãŸã¯è¶…ãˆã‚‹ã“ã¨ã¯ã§ããªã„ãŸã‚ã€ãƒ«ãƒ¼ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ã®å¢—åŠ ã«å‚™ãˆã¦ä½™è£•ã‚’æ®‹ã—ã¦ãŠãã¾ã™ã€‚
>ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ãƒ«ãƒ¼ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ãƒ¼è¦ä»¶ã‚’ã€è¿½åŠ ã™ã‚‹äºˆå®šãŒã‚ã‚‹ãƒ«ãƒ¼ãƒ«ã®æ•°ã¨ã—ã¦è¦‹ç©ã‚‚ã‚Šã¾ã™ã€‚

https://docs.aws.amazon.com/ja_jp/network-firewall/latest/developerguide/rule-group-capacity.html
>Estimate a stateful rule group's capacity as the number of rules that you expect to have in it during its lifetime. You can't change this setting after you create the rule group.
>The maximum capacity setting for a stateful rule group is 30,000.
>ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ãƒ«ãƒ¼ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ã®å®¹é‡ã‚’ã€ãã®å­˜ç¶šæœŸé–“ä¸­ã«ãã®ä¸­ã«ã‚ã‚‹ã¨äºˆæƒ³ã•ã‚Œã‚‹ãƒ«ãƒ¼ãƒ«ã®æ•°ã¨ã—ã¦è¦‹ç©ã‚‚ã‚Šã¾ã™ã€‚ãƒ«ãƒ¼ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆå¾Œã«ã“ã®è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
>ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ãƒ«ãƒ¼ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ã®æœ€å¤§å®¹é‡è¨­å®šã¯30,000ã§ã™ã€‚

ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ï¼‘ã§è¨­å®šã—ã¦
![](https://storage.googleapis.com/zenn-user-upload/7e61c450979ce749efd52dbf.png)

è¿½åŠ ã§ãƒ«ãƒ¼ãƒ«è¿½åŠ ã‚’ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™
![](https://storage.googleapis.com/zenn-user-upload/62783cb7f6cc281d9a6029c4.png)


ã“ã®capacityãŒå˜ç´”ã«ãƒ«ãƒ¼ãƒ«æ•°ãªã®ã‹ã€ã‚¢ã‚¯ã‚»ã‚¹æ•°ãªã®ã‹ã§ã™ãŒã€ä»¥ä¸‹ãƒ«ãƒ¼ãƒ—å‡¦ç†ã‚’è¤‡æ•°ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰æŠ•ã’ã¦ã¿ã¦ã‚‚ç‰¹ã«httpã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚„ãƒ­ã‚°ã«å¤‰æ›´ã¯ç„¡ã„ã®ã§ã€å˜ç´”ã«ãƒ«ãƒ¼ãƒ«æ•°ãªã®ã‹ã‚‚çŸ¥ã‚Œã¾ã›ã‚“ã€‚
```
while true
do
  curl -s http://ã‚¢ãƒ‰ãƒ¬ã‚¹/ -o /dev/null -w '%{http_code}\n'
  date
done
```

## 5-tuple
- é€ä¿¡å…ƒIPã‚¢ãƒ‰ãƒ¬ã‚¹
- é€ä¿¡å…ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹
- é€ä¿¡å…ƒãƒãƒ¼ãƒˆç•ªå·
- é€ä¿¡å…ˆãƒãƒ¼ãƒˆç•ªå·
- ãƒ—ãƒ­ãƒˆã‚³ãƒ«
ã§ãƒ«ãƒ¼ãƒ«ã‚’æŒ‡å®šã—ã¾ã™ã€‚ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã¨ã‹NACLã§ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã«è¿‘ã„ã®ã§é•å’Œæ„Ÿã¯å°‘ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚

## Suricata compatible IPS rules
https://docs.aws.amazon.com/ja_jp/network-firewall/latest/developerguide/stateful-rule-groups-ips.html

https://suricata.readthedocs.io/en/suricata-5.0.0/rules/intro.html

### Rules Format
è¨˜è¼‰ã™ã‚‹ã“ã¨ã¯å¤§ããã¯ï¼“ã¤
- action
  å¯¾è±¡ã«ä½•ã‚’èµ·ã“ã™ã‹
- header
  ãƒ«ãƒ¼ãƒ«ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã€IPã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒãƒ¼ãƒˆã€ãŠã‚ˆã³æ–¹å‘ã‚’å®šç¾©
- rule options
  ãƒ«ãƒ¼ãƒ«ã®è©³ç´°ã‚’å®šç¾©

ä¾‹ãˆã°ä»¥ä¸‹Suricataã§ã¯
```
drop tcp $HOME_NET any -> $EXTERNAL_NET any (msg:â€ET TROJAN Likely Bot Nick in IRC (USA +..)â€; flow:established,to_server; flowbits:isset,is_proto_irc; content:â€NICK â€œ; pcre:â€/NICK .*USA.*[0-9]{3,}/iâ€; reference:url,doc.emergingthreats.net/2008124; classtype:trojan-activity; sid:2008124; rev:2;)
```
- action
  drop
- header
  tcp $HOME_NET any -> $EXTERNAL_NET any
- rule options
  (msg:â€ET TROJAN Likely Bot Nick in IRC (USA +..)â€; flow:established,to_server; flowbits:isset,is_proto_irc; content:â€NICK â€œ; pcre:â€/NICK .*USA.*[0-9]{3,}/iâ€; reference:url,doc.emergingthreats.net/2008124; classtype:trojan-activity; sid:2008124; rev:2;)

#### action
- Pass
  ãƒ‘ã‚±ãƒƒãƒˆã®ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢ã—ã€ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒ«ã®æœ€å¾Œã«ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™
- Drop
  ãƒ‘ã‚±ãƒƒãƒˆã¯ãã‚Œä»¥ä¸Šé€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚æ¬ ç‚¹ï¼šå—ä¿¡è€…ã¯ä½•ãŒèµ·ã“ã£ã¦ã„ã‚‹ã‹ã«ã¤ã„ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãªã„ãŸã‚ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«ãªã‚Šã¾ã™
- Reject
  ãƒ‘ã‚±ãƒƒãƒˆã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ‹’å¦ã§ã™ã€‚å—ä¿¡è€…ã¨é€ä¿¡è€…ã®ä¸¡æ–¹ãŒæ‹’å¦ãƒ‘ã‚±ãƒƒãƒˆã‚’å—ä¿¡ã—ã¾ã™
- Alert
  ãƒ‘ã‚±ãƒƒãƒˆã¯ä»–ã®è„…å¨ã®ãªã„ãƒ‘ã‚±ãƒƒãƒˆã¨åŒæ§˜ã«æ‰±ã‚ã‚Œã¾ã™ãŒã€ã‚¢ãƒ©ãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã™


#### header - protocol
headerã¯ç´°åˆ†åŒ–ã™ã‚‹ã¨ã¾ãšãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«åˆ†å‰²ã§ãã¾ã™
tcp,udp,httpã¨ã‹ã¨ã‹

#### header - source and destination
headerã¯ç´°åˆ†åŒ–ã™ã‚‹ã¨æ¬¡ã«é€ä¿¡å…ƒå…ˆã«åˆ†å‰²ã§ãã¾ã™
IPãƒ¬ãƒ³ã‚¸ã‚’listãªã©ã§è¡¨ç¾å¯èƒ½ã§ã™

#### header - ports
headerã¯ç´°åˆ†åŒ–ã™ã‚‹ã¨æ¬¡ã«é€ä¿¡å…ƒå…ˆã®portã«åˆ†å‰²ã§ãã¾ã™
portã‚’listãªã©ã§è¡¨ç¾å¯èƒ½ã§ã™

#### header - direction
- ->
  clientã‹ã‚‰serverã¸ã®ä¸€æ–¹ã®æµã‚Œ
- <>
  clientã¨serveråŒæ–¹ã®æµã‚Œ
- <-
  ã“ã‚Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚serverã‹ã‚‰clientã‹ã‚‰ã¸ã®ä¸€æ–¹ã®æµã‚Œ

#### rule
ãƒ«ãƒ¼ãƒ«ã®æ®‹ã‚Šã®éƒ¨åˆ†ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯æ‹¬å¼§ã§å›²ã¾ã‚Œã€ã‚»ãƒŸã‚³ãƒ­ãƒ³ã§åŒºåˆ‡ã‚‰ã‚Œã¾ã™ã€‚ä¸€éƒ¨ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¯è¨­å®šï¼ˆmsgãªã©ï¼‰ãŒã‚ã‚Šã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã‚³ãƒ­ãƒ³ã€è¨­å®šã®é †ã«æŒ‡å®šã•ã‚Œã¾ã™ã€‚ãã®ä»–ã«ã¯è¨­å®šãŒãªãã€å˜ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆnocaseãªã©ï¼‰ã§ã™ã€‚

â€¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ãƒ’ãƒƒãƒˆã™ã‚‹ã‹ã‚’è¦‹ã‚‹ã®ã‹ãªã€‚è©³ç´°ã‚’è¨˜è¼‰ã™ã‚‹ã®ã¯æ…£ã‚ŒãŒå¿…è¦ã§ã™ãŒã€ã§ã‚‚Suricataã®5-tupleã¨ã¯é•ã†å¼·ã¿ã ã¨æ€ã„ã¾ã™ã€‚

ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ãƒ­ã‚°ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹æƒ…å ±ã¨ã‹ã‹ã‚‰é¸æŠã™ã‚Œã°ãˆãˆã®ã‹ãª
```
{
    "firewall_name": "nwfw",
    "availability_zone": "ap-northeast-1a",
    "event_timestamp": "1623492831",
    "event": {
        "timestamp": "2021-06-12T10:13:51.763325+0000",
        "flow_id": 1848277047251586,
        "event_type": "alert",
        "src_ip": "14.8.57.96",
        "src_port": 53362,
        "dest_ip": "10.0.1.131",
        "dest_port": 80,
        "proto": "TCP",
        "alert": {
            "action": "allowed",
            "signature_id": 1,
            "rev": 0,
            "signature": "",
            "category": "",
            "severity": 3
        },
        "app_proto": "http"
    }
}
```