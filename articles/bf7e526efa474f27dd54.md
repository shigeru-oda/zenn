---
title: "FastAPI,mangumã‚’ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã—ã¦APIã«ã™ã‚‹"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws","åº§å­¦","èª¿ã¹ç‰©"]
published: true
---

# éå»ãƒ­ã‚°

### 1å›ç›®
https://zenn.dev/shigeru_oda/articles/f1d360786c41568d16fa

### 2å›ç›®
https://zenn.dev/shigeru_oda/articles/ee2ec43507a62f3e7c1d

# ã‚„ã‚ŠãŸã„ã“ã¨
å‰å›ã‚„ã‚ŒãŸã“ã¨
![](https://storage.googleapis.com/zenn-user-upload/ddf2fe008063-20230202.png)

æ§‹æˆå›³
![](https://storage.googleapis.com/zenn-user-upload/20c92cbcc8c4-20230202.png)

2å›ç›®ã®è¨˜äº‹ã§FastAPI,mangumã‚’åˆ©ç”¨ã—ã¦ã€swagger-uiä¸Šã§ã®APIç®¡ç†ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã‚‰ã‚’ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã—ãŸä¸Šã§ã€Lambda+API Gatewayã‚’ä½œã£ã¦ãƒ†ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™ã€‚
SAMã®Deployã§ã¯ãªãCLIã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ã—ã¦ã„ã¾ã™ã€‚SAMã¯æ¬¡å›ã«ã§ã‚‚ã€‚

# ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ
```
sam-app-1
- events
  |- event.json
- hello_world
  |- Dockerfile <- æ–°è¦ä½œæˆ
  |- app.py
  |- __init__.py
  |- requirements.txt
- tests
  |- __init__.py
  |- integration
    |- __init__.py
    |- test_api_gateway.py
  |- requirements.txt
  |- unit
    |- __init__.py
    |- test_api_gateway.py
- __init__.py
- README.md
- response.json
- samconfig.toml
- template.yaml
```


# ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™
### Dockerfile
`./sam-app-1/hello_world/Dockerfile`ã‚’ä½œæˆã—ã¾ã™ã€‚  
åŸºæœ¬çš„ãªè¨˜è¼‰æ–¹æ³•ã¯AWSå…¬å¼ã«å¾“ã„ã¾ã™ãŒã€pythonã®Versionã¯3.9ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚  
ã¾ãŸCMDã¯app.pyã«è¨˜è¼‰ã•ã‚ŒãŸãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®åå‰ã¨ãªã‚Šã¾ã™

https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/images-create.html#images-create-from-base


```
FROM public.ecr.aws/lambda/python:3.9

# Install the function's dependencies using file requirements.txt
# from your project folder.

COPY requirements.txt  .
RUN  pip3 install -r requirements.txt --target "${LAMBDA_TASK_ROOT}"

# Copy function code
COPY app.py ${LAMBDA_TASK_ROOT}

# Set the CMD to your handler (could also be done as a parameter override outside of the Dockerfile)
CMD [ "app.lambda_handler" ] 
```

### app.py
å¤‰æ›´ç‚¹ã¯ç„¡ã„ã§ã™ãŒã€å†åº¦æ²è¼‰
```
from fastapi import FastAPI
from mangum import Mangum

app = FastAPI()

@app.get("/hello")
def root():
    return {"message": "Hello World"}

lambda_handler = Mangum(app)
```

### requirements.txt
å¤‰æ›´ç‚¹ã¯ç„¡ã„ã§ã™ãŒã€å†åº¦æ²è¼‰
```
requests
fastapi
mangum
```


# ç’°å¢ƒæ§‹ç¯‰
### ECRãƒªãƒã‚¸ãƒˆãƒªæº–å‚™
```
aws ecr create-repository --repository-name hello_world 
```


### Dockeræº–å‚™
```
# AWSæƒ…å ±å–å¾—
REGION=$(aws configure get region)
ACCOUNTID=$(aws sts get-caller-identity --output text --query Account)

# build
docker build -t hello_world .

# tagè¨­å®š
docker tag hello_world:latest ${ACCOUNTID}.dkr.ecr.${REGION}.amazonaws.com/hello_world:latest

# ECRãƒ­ã‚°ã‚¤ãƒ³
aws ecr get-login-password | docker login --username AWS --password-stdin ${ACCOUNTID}.dkr.ecr.${REGION}.amazonaws.com

# ECRã¸push
docker push ${ACCOUNTID}.dkr.ecr.${REGION}.amazonaws.com/hello_world:latest
```

### IAMæº–å‚™
æ¨©é™ã®å•é¡Œã§Cloud9ã§ã¯ã‚¨ãƒ©ãƒ¼ã¨ãªã‚‹ã®ã§ã€ã“ã“ã¯CloudShellã§å®Ÿè¡Œä¸‹ã•ã„
```
# Roleä½œæˆ
aws iam create-role --role-name lambda-hello_world \
--assume-role-policy-document '{"Version": "2012-10-17","Statement": [{ "Effect": "Allow", "Principal": {"Service": "lambda.amazonaws.com"}, "Action": "sts:AssumeRole"}]}'
```

### Lambdaæº–å‚™
```
# Roleå¤‰æ•°è¨­å®š
ROLE_ARN=arn:aws:iam::${ACCOUNTID}:role/lambda-hello_world

# DIGESTå–å¾—
DIGEST=$(aws ecr list-images --repository-name hello_world --out text --query 'imageIds[?imageTag==`latest`].imageDigest')

# Lambdaé–¢æ•°ä½œæˆ
aws lambda create-function \
  --function-name hello_world \
  --package-type Image \
  --code ImageUri=${ACCOUNTID}.dkr.ecr.${REGION}.amazonaws.com/hello_world@${DIGEST} \
  --role ${ROLE_ARN}
```


### Lambdaãƒ†ã‚¹ãƒˆ
å®Ÿè¡Œçµæœã®"body"ãŒ{"message":"Hello World"}ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™
```
# payloadæº–å‚™
cat << EOF > payload.json
{
  "resource": "/",
  "path": "/hello",
  "httpMethod": "GET",
  "isBase64Encoded": true,
  "queryStringParameters": {
    "foo": "bar"
  },
  "requestContext": {
    "httpMethod": "GET"
  }
}
EOF

# Lambdaå®Ÿè¡Œ
aws lambda invoke \
  --function-name hello_world \
  --payload file://payload.json \
  --cli-binary-format raw-in-base64-out \
  response.json

# ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª
cat response.json

# ã‚´ãƒŸå‰Šé™¤
rm payload.json response.json
```

### API Gatewayä½œæˆ
```
# REST APIã®ä½œæˆ
aws apigateway create-rest-api \
  --name 'api_hello_world' \
  --description 'api_hello_world' \
  --endpoint-configuration types=REGIONAL

# API IDã®å–å¾—
apigateway_id=$(aws apigateway get-rest-apis \
  --query 'items[?name==`api_hello_world`].id' \
  --output text);echo ${apigateway_id}

# ãƒªã‚½ãƒ¼ã‚¹ IDã®å–å¾—
resource_id=$(aws apigateway get-resources \
  --rest-api-id ${apigateway_id} \
  --query 'items[?path==`/`].id' \
  --output text);echo ${resource_id}

# ãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆ
aws apigateway create-resource \
  --rest-api-id ${apigateway_id} \
  --parent-id ${resource_id} \
  --path-part '{proxy+}'

# ãƒªã‚½ãƒ¼ã‚¹ IDã®å–å¾—
resource_id_proxy=$(aws apigateway get-resources \
  --rest-api-id ${apigateway_id} \
  --query 'items[?path==`/{proxy+}`].id' \
  --output text);echo ${resource_id_proxy}

# ãƒ¡ã‚½ãƒƒãƒ‰ã®ä½œæˆ
aws apigateway put-method \
  --rest-api-id ${apigateway_id} \
  --resource-id ${resource_id_proxy} \
  --http-method GET \
  --authorization-type "NONE" \
  --no-api-key-required 

# ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š
aws apigateway put-integration \
  --rest-api-id ${apigateway_id} \
  --resource-id ${resource_id_proxy} \
  --http-method GET \
  --type AWS_PROXY \
  --integration-http-method POST \
  --uri "arn:aws:apigateway:${REGION}:lambda:path/2015-03-31/functions/arn:aws:lambda:${REGION}:${ACCOUNTID}:function:hello_world/invocations"

# Lambdaé–¢æ•°ã®å®Ÿè¡Œæ¨©é™ä»˜ä¸
aws lambda add-permission \
  --function-name hello_world \
  --statement-id hello_world \
  --action lambda:InvokeFunction \
  --principal apigateway.amazonaws.com \
  --source-arn "arn:aws:execute-api:${REGION}:${ACCOUNTID}:${apigateway_id}/*/*/*"

# APIã®ãƒ‡ãƒ—ãƒ­ã‚¤
aws apigateway create-deployment \
  --rest-api-id ${apigateway_id} \
  --stage-name default \
  --stage-description default \
  --description default
```


### APIãƒ†ã‚¹ãƒˆ
å®Ÿè¡Œ(æˆåŠŸä¾‹)
```
URI="https://${apigateway_id}.execute-api.${REGION}.amazonaws.com/default/hello"
curl -H "Content-Type: application/json" -X GET ${URI}
```

çµæœ(æˆåŠŸä¾‹)
```
{"message":"Hello World"}
```

å®Ÿè¡Œ(å¤±æ•—ä¾‹)
```
URI="https://${apigateway_id}.execute-api.${REGION}.amazonaws.com/default/hello-test"
curl -H "Content-Type: application/json" -X GET ${URI}
```

çµæœ(å¤±æ•—ä¾‹)
```
{"detail":"Not Found"}
```

# ã¾ã¨ã‚
FastAPI,mangumã§swagger-uiã§APIã‚’ç®¡ç†ã—ã¤ã¤ã€ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã¾ã§å‡ºæ¥ã¾ã—ãŸã€‚

# å‚è€ƒ
https://aws.amazon.com/jp/builders-flash/202103/new-lambda-container-development/?awsf.filter-name=*all
