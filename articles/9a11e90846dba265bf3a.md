---
title: "ã€æ„Ÿæƒ³ã€‘AWSã®åŸºç¤Žã‚’å­¦ã¼ã† ç‰¹åˆ¥ç·¨ã€€æœ€æ–°ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã¿ã‚“ãªã§è§¦ã£ã¦ã¿ã‚‹ åˆã‚ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥"
emoji: "ðŸš´ðŸ»â€â™€ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws","æ„Ÿæƒ³"]
published: true
---
# æœ€åˆã«
é€”ä¸­ã§é “æŒ«ã—ã¦ã„ã¾ã™ã€‚
çµŒéŽå ±å‘Šã§ã™ã€‚

# æ¦‚è¦
ã€ŒAWSã®åŸºç¤Žã‚’å­¦ã¼ã† ç‰¹åˆ¥ç·¨ã€ã§â€AWS AppMesh ã¨ AWS Cloud Mapâ€ã®ãƒãƒ³ã‚ºã‚ªãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã«å‚åŠ ã—ãŸæ„Ÿæƒ³ãƒšãƒ¼ã‚¸ã§ã™ã€‚

# ã€ŒAWS ã‚¨ãƒãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã‚·ãƒªãƒ¼ã‚ºã€€AWSã®åŸºç¤Žã‚’å­¦ã¼ã†ã€ã¨ã¯
[AWS ã‚¨ãƒãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã‚·ãƒªãƒ¼ã‚ºã€€AWSã®åŸºç¤Žã‚’å­¦ã¼ã†](https://awsbasics.connpass.com)

ä»¥ä¸‹ã€Connpassãƒšãƒ¼ã‚¸ã‚ˆã‚Šå¼•ç”¨

>  Amazon Web Services (AWS)ã¯ç¾åœ¨200ã‚’è¶…ãˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ã€æ—¥ã€…ã‚µãƒ¼ãƒ“ã‚¹ã®æ‹¡å……ã‚’ç¶šã‘ã¦ã„ã¾ã™ã€‚
> ã“ã®AWS ã‚¨ãƒãƒ³ãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã‚·ãƒªãƒ¼ã‚ºã§ã¯é€±æ¬¡ã§AWSã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã²ã¨ã¤ã¥ã¤å–ã‚Šä¸Šã’ãªãŒã‚‰ãã®åŸºç¤Žã‚’èª¬æ˜Žã—ã¦ã„ã åˆå¿ƒè€…ã€ä¸­ç´šè€…ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã—ãŸè¬›åº§ã§ã™ã€‚åˆå¾Œã®ä»•äº‹å‰ã«ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã‚’ä¸€ç·’ã«ã—ã¾ã›ã‚“ã‹ï¼Ÿ
> æ³¨æ„ç‚¹ ç™»å£‡è€…ã«ã‚ˆã‚‹ç™ºè¡¨å†…å®¹ã¯ã‚¢ãƒžã‚¾ãƒ³ ã‚¦ã‚§ãƒ– ã‚µãƒ¼ãƒ“ã‚¹ ã‚¸ãƒ£ãƒ‘ãƒ³ã¨ã—ã¦ä¸»å‚¬ã—ã¦ã„ã‚‹ã‚‚ã®ã§ã¯ãªãã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ´»å‹•ã®ä¸€ç’°ã¨ã—ã¦å‹‰å¼·ä¼šã®ä¸»å‚¬ã‚’è¡Œã£ã¦ã„ã‚‹ã‚‚ã®ã§ã™ã€‚

æ¯Žé€±ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

---
# AWS AppMesh ã¨ AWS Cloud Mapã¨ã¯
## AWS AppMesh
https://aws.amazon.com/jp/app-mesh

**AWS App Mesh ã¨ã¯ä½•ã§ã™ã‹?**
AWS App Mesh ã§ã€ã‚µãƒ¼ãƒ“ã‚¹é–“ã®é€šä¿¡ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã€ç®¡ç†ã€ãƒ‡ãƒãƒƒã‚°ãŒç°¡å˜ã«ãªã‚Šã¾ã™ã€‚App Mesh ã¯ã€ãƒžã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã¨åŒæ™‚ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ãƒ—ãƒ­ã‚­ã‚·ã§ã‚ã‚‹ Envoy ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚App Mesh ã¯ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¨è¿½è·¡ã®ãŸã‚ã« AWS ã®ã‚µãƒ¼ãƒ“ã‚¹ã¨çµ±åˆã•ã‚Œã€å¤šãã®ä¸€èˆ¬çš„ãªã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£è£½ãƒ„ãƒ¼ãƒ«ã¨ã®ä½¿ç”¨ãŒå¯èƒ½ã§ã™ã€‚App Mesh ã¯ã€Amazon ECSã€Amazon EKSã€AWS Fargateã€AWS ã§å®Ÿè¡Œã™ã‚‹ Kubernetes ãŒç®¡ç†ã™ã‚‹ãƒžã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã€ãŠã‚ˆã³ Amazon EC2 ä¸Šã§å®Ÿè¡Œã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ä½¿ç”¨ã§ãã¾ã™ã€‚

EC2ä¸Šã§ã‚‚å‹•ãã®ã‹ãƒ¼

## AWS Cloud Map
https://aws.amazon.com/jp/cloud-map/

**AWS Cloud Map ã¨ã¯**
AWS Cloud Map ã¯ã€ã‚¯ãƒ©ã‚¦ãƒ‰ãƒªã‚½ãƒ¼ã‚¹æ¤œå‡ºã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚Cloud Map ã§ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚½ãƒ¼ã‚¹ã«ã‚«ã‚¹ã‚¿ãƒ åã‚’ä»˜ã‘ã‚‹ã“ã¨ãŒã§ãã€ã“ã‚Œã‚‰ã®å‹•çš„ã«å¤‰åŒ–ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®å ´æ‰€ã‚’è‡ªå‹•çš„ã«æ›´æ–°ã—ã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãã®ãƒªã‚½ãƒ¼ã‚¹ã®æœ€æ–°ã®å ´æ‰€ã‚’å¸¸ã«æ¤œå‡ºã™ã‚‹ãŸã‚ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¯ç”¨æ€§ãŒå‘ä¸Šã—ã¾ã™ã€‚
ãƒ¢ãƒ€ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ä¸€èˆ¬çš„ã«ã€API ã‚’é€šã˜ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã€ç‰¹å®šã®æ©Ÿèƒ½ã‚’å®Ÿè¡Œã™ã‚‹è¤‡æ•°ã®ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚å„ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ã‚­ãƒ¥ãƒ¼ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢ã€ã‚«ã‚¹ã‚¿ãƒžãƒ¼å®šç¾©ã®ãƒžã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¨ã„ã£ãŸã•ã¾ã–ã¾ãªä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã¨å¯¾è©±ã‚’ã—ã¾ã™ãŒã€æ©Ÿèƒ½ã™ã‚‹ãŸã‚ã«ã¯ã€ä¾å­˜ã—ã¦ã„ã‚‹ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒªã‚½ãƒ¼ã‚¹ã™ã¹ã¦ã®å ´æ‰€ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ããªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
Cloud Map ã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ã‚­ãƒ¥ãƒ¼ã€ãƒžã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã€ã‚«ã‚¹ã‚¿ãƒ åã‚’æŒã¤ãã®ä»–ã‚¯ãƒ©ã‚¦ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ãªã©ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚½ãƒ¼ã‚¹ã‚’ç™»éŒ²ã§ãã¾ã™ã€‚ãã®å¾Œã€Cloud Map ã¯ãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ç¶™ç¶šçš„ã«ãƒã‚§ãƒƒã‚¯ã—ã€ãã®å ´æ‰€ãŒæœ€æ–°ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚ãã—ã¦ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒªã‚½ãƒ¼ã‚¹ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒã«åŸºã¥ãã€å¿…è¦ãªå®Ÿéš›ã®ãƒªã‚½ãƒ¼ã‚¹ã®å ´æ‰€ã‚’ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ã‚¯ã‚¨ãƒªã§ãã¾ã™ã€‚


---
# ç´è§£ã„ã¦è¡Œã“ã†ã€‚
äº€ç”°ã•ã‚“ã®ãƒãƒ³ã‚ºã‚ªãƒ³è³‡æ
https://github.com/harunobukameda/AWS-App-Mesh-AWS-Cloud-Map

ãƒãƒ³ã‚ºã‚ªãƒ³ã‚’ã‚„ã£ã¦ã„ã¦ä½•ã‚’ã—ã¦ã„ã‚‹ã‹ãŒç†è§£ã§ããªã„ç‚¹ãŒå¤šã‹ã£ãŸã®ã§ã€ãã‚Œã‚’ç´è§£ã„ã¦è¡Œã“ã†ã€‚
ä¸»ã«ã‚³ãƒžãƒ³ãƒ‰ã®ç´è§£ã

## 1.
```
rm -vf ${HOME}/.aws/credentials
```
**æ„å›³ï¼æ„å‘³**
Cloud9ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¤ã„ã¦ã„ã‚‹credentialsã‚’å‰Šé™¤ã—ã€EC2ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã€‚



## 2.
```
export ACCOUNT_ID=$(aws sts get-caller-identity --output text --query Account)
export AWS_REGION=$(curl -s 169.254.169.254/latest/dynamic/instance-identity/document | \
  grep region | cut -d\" -f4)

echo "export ACCOUNT_ID=${ACCOUNT_ID}" >> ~/.bash_profile
echo "export AWS_REGION=${AWS_REGION}" >> ~/.bash_profile
aws configure set default.region ${AWS_REGION}
aws configure get default.region
```
**æ„å›³ï¼æ„å‘³**
bash_profileã«ACCOUNT_IDã€AWS_REGIONã‚’è¨­å®šã™ã‚‹  
aws configureã«default.regionã‚’è¨­å®šã™ã‚‹



## 3.
```
aws sts get-caller-identity
```
**æ„å›³ï¼æ„å‘³**
ä»Šä½¿ã£ã¦ã„ã‚‹RoleãŒAppMesh-Workshop-Adminã§ã‚ã‚‹ã‹ç¢ºèªã™ã‚‹



## 4.
```
# create a folder for the scripts
mkdir ~/environment/scripts

# tools script
cat > ~/environment/scripts/install-tools <<-"EOF"

#!/bin/bash -ex

sudo yum install -y jq gettext bash-completion

sudo curl --silent --location "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/linux_64bit/session-manager-plugin.rpm" -o "session-manager-plugin.rpm"
sudo yum install -y session-manager-plugin.rpm

sudo curl --silent --location -o /usr/local/bin/kubectl https://storage.googleapis.com/kubernetes-release/release/v1.16.8/bin/linux/amd64/kubectl
sudo chmod +x /usr/local/bin/kubectl
echo 'source <(kubectl completion bash)' >>~/.bashrc
source ~/.bashrc

curl --silent --location "https://github.com/weaveworks/eksctl/releases/download/latest_release/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
sudo mv -v /tmp/eksctl /usr/local/bin

if ! [ -x "$(command -v jq)" ] || ! [ -x "$(command -v envsubst)" ] || ! [ -x "$(command -v kubectl)" ] || ! [ -x "$(command -v eksctl)" ] || ! [ -x "$(command -v ssm-cli)" ]; then
  echo 'ERROR: tools not installed.' >&2
  exit 1
fi

pip install awscli --upgrade --user

EOF

chmod +x ~/environment/scripts/install-tools
```
**æ„å›³ï¼æ„å‘³**
/environment/scripts/install-toolsã¨ã„ã†scriptã‚’ä½œæˆã—ã¦ã„ã‚‹ã€‚scriptã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹ã®ã¯ä»¥ä¸‹  
- jq
JSONã‹ã‚‰æŠ½å‡ºã€é›†è¨ˆã€æ•´å½¢ã™ã‚‹æ©Ÿèƒ½

- gettext
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å›½éš›åŒ–ãŒã§ãã‚‹æ©Ÿèƒ½ã€‚ä¾‹ãˆã°æ—¥æœ¬ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã«ã¯ã€Œã‚ˆã†ã“ãã€ã€ã‚¢ãƒ¡ãƒªã‚«ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã«ã¯ã€ŒWelcomeã€ã¨åˆ‡ã‚Šåˆ†ã‘ã‚‹

- bash-completion
ã‚³ãƒžãƒ³ãƒ‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§å…¥åŠ›è£œå®Œã‚’ã—ã¦ãã‚Œã‚‹æ©Ÿèƒ½

- session-manager-plugin
AWS Session Managerã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³

- kubectl
Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’åˆ¶å¾¡ã™ã‚‹ã‚³ãƒžãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«

- eksctl
Amazon EKSã®ã‚¯ãƒ©ã‚¹ã‚¿ã¨ãƒŽãƒ¼ãƒ‰ã‚’åˆ¶å¾¡ã™ã‚‹ã‚³ãƒžãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«

- aws cli
Cloud9ã«ã‚‚ã¨ã‚‚ã¨ã‚ã‚‹ã‘ã©UPDATE



## 5.
```
~/environment/scripts/install-tools
```
**æ„å›³ï¼æ„å‘³**
4ã§ä½œæˆã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ



## 6.
```
# clone the github repositories
cd ~/environment
git clone https://github.com/brentley/ecsdemo-frontend.git
git clone https://github.com/brentley/ecsdemo-nodejs.git
git clone https://github.com/brentley/ecsdemo-crystal.git
```
**æ„å›³ï¼æ„å‘³**
ãƒãƒ³ã‚ºã‚ªãƒ³ã§å¿…è¦ãªè³‡æã‚’githubã‹ã‚‰clone



### 7.
```
cd ~/environment
curl -s https://raw.githubusercontent.com/brentley/appmeshworkshop/master/templates/appmesh-baseline.yml -o appmesh-baseline.yml
```
**æ„å›³ï¼æ„å‘³**
appmeshworkshopã®CloudFormationãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’GET
1000è¡Œã‚‚ã‚ã‚‹ãªãã€‚ã€‚ã€‚



### 8.
```
# Define environment variable
IAM_ROLE=$(curl -s 169.254.169.254/latest/meta-data/iam/info | \
  jq -r '.InstanceProfileArn' | cut -d'/' -f2)

#Check if the template is already deployed. If not, deploy it
CFN_TEMPLATE=$(aws cloudformation list-stacks | jq -c '.StackSummaries[].StackName | select( . == "appmesh-workshop" )')

if [ -z "$CFN_TEMPLATE" ]
then
  echo "Deploying Cloudformation Template"
  aws cloudformation deploy \
    --template-file appmesh-baseline.yml \
    --stack-name appmesh-workshop \
    --capabilities CAPABILITY_IAM \
    --parameter-overrides Cloud9IAMRole=$IAM_ROLE
else
  echo "Template already deployed. Go ahead to the next chapter."
fi
```
**æ„å›³ï¼æ„å‘³**
- curl -s 169.254.169.254/latest/meta-data/iam/info
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã€‚ã€€ã“ã‚ŒçŸ¥ã‚‰ã‚“ã‹ã£ãŸã€‚

- aws cloudformation list-stacks | jq -c '.StackSummaries[].StackName | select( . == "appmesh-workshop" )'
appmesh-workshopã¨ã„ã†StackãŒã‚ã‚‹ã‹ç¢ºèª  
StatusãŒDELETE_COMPLETEã®Stackã‚‚å–å¾—ã§ãã¡ã‚ƒã†ã®ã§ã€DELETE_COMPLETEã§ã‚ã‚‹ãªã‚‰å®Ÿè¡Œã—ã¦ã‚‚ãˆãˆã‹ãªã€‚

- aws cloudformation deploy \
    --template-file appmesh-baseline.yml \
    --stack-name appmesh-workshop \
    --capabilities CAPABILITY_IAM \
    --parameter-overrides Cloud9IAMRole=$IAM_ROLE
AWS CLIã§cloudformation deployã‚’å®Ÿè¡Œ

### 8è£œè¶³ appmesh-baseline.yml
```
https://raw.githubusercontent.com/brentley/appmeshworkshop/master/templates/appmesh-baseline.yml
```
**æ„å›³ï¼æ„å‘³**
1000è¡Œãã‚‰ã„ã‚ã‚‹ã®ã§ãƒªãƒ³ã‚¯å…ˆå‚ç…§
- Crystal
ECRä½œæˆ
- NodeJS
ECRä½œæˆ
- ECSCluster
ECSã‚¯ãƒ©ã‚¹ã‚¿ä½œæˆ
- CrystalTaskDefinition
ECSã‚¿ã‚¹ã‚¯å®šç¾©
- ExternalLoadBalancerSecurityGroup
LBã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—
- ExternalLoadBalancer
LBä½œæˆ ç´ä»˜ããƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆã¯3ã¤
- ExternalListener
LBã®ãƒªã‚¹ãƒŠãƒ¼ã¯http
- RubyTargetGroup



### 9.
```
# Retrieve private key
aws ssm get-parameter \
  --name /appmeshworkshop/keypair/id_rsa \
  --with-decryption | jq .Parameter.Value --raw-output > ~/.ssh/id_rsa

# Set appropriate permission on private key
chmod 600 ~/.ssh/id_rsa

# Store public key separately from private key
ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub
```
**æ„å›³ï¼æ„å‘³**
- aws ssm get-parameterâ€¦
CloudFormationã§ä½œæˆã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ã‚¿ã‚¹ãƒˆã‚¢ã«ã‚ã‚‹å€¤ã‚’å¾©å·åŒ–ã—ã¦~/.sshé…ä¸‹ã«ç§˜å¯†éµã¨ã—ã¦å‡ºåŠ›
- ssh-keygenâ€¦
ç§˜å¯†éµã‚ˆã‚Šå…¬é–‹éµã‚’ä½œæˆã—ã¦~/.sshé…ä¸‹ã«å‡ºåŠ›



## 10.
```
# bootstrap script
cat > ~/environment/scripts/bootstrap <<-"EOF"

#!/bin/bash -ex

echo 'Fetching CloudFormation outputs'
~/environment/scripts/fetch-outputs
echo 'Building Docker Containers'
~/environment/scripts/build-containers
echo 'Creating the ECS Services'
~/environment/scripts/create-ecs-service
echo 'Creating the EKS Cluster'
~/environment/scripts/build-eks

EOF

# fetch-outputs script
cat > ~/environment/scripts/fetch-outputs <<-"EOF"

#!/bin/bash -ex

STACK_NAME=appmesh-workshop
aws cloudformation describe-stacks \
  --stack-name "$STACK_NAME" | \
jq -r '[.Stacks[0].Outputs[] | 
    {key: .OutputKey, value: .OutputValue}] | from_entries' > cfn-output.json

EOF

# Create EKS configuration file
cat > ~/environment/scripts/eks-configuration <<-"EOF"

#!/bin/bash -ex

STACK_NAME=appmesh-workshop
PRIVSUB1_ID=$(jq < cfn-output.json -r '.PrivateSubnetOne')
PRIVSUB1_AZ=$(aws ec2 describe-subnets --subnet-ids $PRIVSUB1_ID | jq -r '.Subnets[].AvailabilityZone')
PRIVSUB2_ID=$(jq < cfn-output.json -r '.PrivateSubnetTwo')
PRIVSUB2_AZ=$(aws ec2 describe-subnets --subnet-ids $PRIVSUB2_ID | jq -r '.Subnets[].AvailabilityZone')
PRIVSUB3_ID=$(jq < cfn-output.json -r '.PrivateSubnetThree')
PRIVSUB3_AZ=$(aws ec2 describe-subnets --subnet-ids $PRIVSUB3_ID | jq -r '.Subnets[].AvailabilityZone')
AWS_REGION=$(curl -s 169.254.169.254/latest/dynamic/instance-identity/document | grep region | cut -d\" -f4)

cat > /tmp/eks-configuration.yml <<-EKS_CONF
  apiVersion: eksctl.io/v1alpha5
  kind: ClusterConfig
  metadata:
    name: $STACK_NAME
    region: $AWS_REGION
  vpc:
    subnets:
      private:
        $PRIVSUB1_AZ: { id: $PRIVSUB1_ID }
        $PRIVSUB2_AZ: { id: $PRIVSUB2_ID }
        $PRIVSUB3_AZ: { id: $PRIVSUB3_ID }
  nodeGroups:
    - name: appmesh-workshop-ng
      labels: { role: workers }
      instanceType: m5.large
      desiredCapacity: 3
      ssh: 
        allow: false
      privateNetworking: true
      iam:
        withAddonPolicies:
          imageBuilder: true
          albIngress: true
          autoScaler: true
          appMesh: true
          xRay: true
          cloudWatch: true
          externalDNS: true
EKS_CONF

EOF

# Create the EKS building script
cat > ~/environment/scripts/build-eks <<-"EOF"

#!/bin/bash -ex

EKS_CLUSTER_NAME=$(jq < cfn-output.json -r '.EKSClusterName')

if [ -z "$EKS_CLUSTER_NAME" ] || [ "$EKS_CLUSTER_NAME" == null ]
then
  
  if ! aws sts get-caller-identity --query Arn | \
    grep -q 'assumed-role/AppMesh-Workshop-Admin/i-'
  then
    echo "Your role is not set correctly for this instance"
    exit 1
  fi

  sh -c ~/environment/scripts/eks-configuration
  eksctl create cluster -f /tmp/eks-configuration.yml
else

  NODES_IAM_ROLE=$(jq < cfn-output.json -r '.NodeInstanceRole')

  aws eks --region $AWS_REGION update-kubeconfig --name $EKS_CLUSTER_NAME
  cat > /tmp/aws-auth-cm.yml <<-EKS_AUTH
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: aws-auth
      namespace: kube-system
    data:
      mapRoles: |
        - rolearn: $NODES_IAM_ROLE 
          username: system:node:{{EC2PrivateDNSName}}
          groups:
            - system:bootstrappers
            - system:nodes
EKS_AUTH
  kubectl apply -f /tmp/aws-auth-cm.yml
fi

EOF

# build-containers script
cat > ~/environment/scripts/build-containers <<-"EOF"

#!/bin/bash -ex

CRYSTAL_ECR_REPO=$(jq < cfn-output.json -r '.CrystalEcrRepo')
NODEJS_ECR_REPO=$(jq < cfn-output.json -r '.NodeJSEcrRepo')

$(aws ecr get-login --no-include-email)

docker build -t crystal-service ecsdemo-crystal
docker tag crystal-service:latest $CRYSTAL_ECR_REPO:vanilla
docker push $CRYSTAL_ECR_REPO:vanilla

docker build -t nodejs-service ecsdemo-nodejs
docker tag nodejs-service:latest $NODEJS_ECR_REPO:latest
docker push $NODEJS_ECR_REPO:latest

EOF

# create-ecs-service script
cat > ~/environment/scripts/create-ecs-service <<-"EOF"

#!/bin/bash -ex

CLUSTER=$(jq < cfn-output.json -r '.EcsClusterName')
TASK_DEF=$(jq < cfn-output.json -r '.CrystalTaskDefinition')
TARGET_GROUP=$(jq < cfn-output.json -r '.CrystalTargetGroupArn')
SUBNET_ONE=$(jq < cfn-output.json -r '.PrivateSubnetOne')
SUBNET_TWO=$(jq < cfn-output.json -r '.PrivateSubnetTwo')
SUBNET_THREE=$(jq < cfn-output.json -r '.PrivateSubnetThree')
SECURITY_GROUP=$(jq < cfn-output.json -r '.ContainerSecurityGroup')

aws ecs create-service \
  --cluster $CLUSTER \
  --service-name crystal-service-lb \
  --task-definition $TASK_DEF \
  --load-balancer targetGroupArn=$TARGET_GROUP,containerName=crystal-service,containerPort=3000 \
  --desired-count 3 \
  --launch-type FARGATE \
  --network-configuration \
      "awsvpcConfiguration={
        subnets=[$SUBNET_ONE,$SUBNET_TWO,$SUBNET_THREE],
        securityGroups=[$SECURITY_GROUP],
        assignPublicIp=DISABLED}"

EOF

chmod +x ~/environment/scripts/*
```
**æ„å›³ï¼æ„å‘³**
/environment/scripts/bootstrapã¨ã„ã†scriptã‚’ä½œæˆã—ã¦ã„ã‚‹ã€‚è¨­å®šå†…å®¹ã¯ä»¥ä¸‹
- bootstrap
å˜ç´”ãªèµ·å‹•Shellã§ã€Œfetch-outputsã€ã€ã€Œbuild-containersã€ã€ã€Œcreate-ecs-serviceã€ã€ã€Œbuild-eksã€ã‚’é †ç•ªã«èµ·å‹•ã—ã¦ã„ã‚‹

- fetch-outputs
CloudFormationã®Outputsã«ã‚ã‚‹æƒ…å ±ã‚’cfn-output.jsonã«å‡ºåŠ›ã™ã‚‹

- build-eks
  eksã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹
  - cfn-output.jsonã‹ã‚‰PRIVSUB1_ID,PRIVSUB2_ID,PRIVSUB3_IDã‚’å–å¾—
  - SUBNET IDã‚’åˆ©ç”¨ã—ã¦AWS CLIã§AZã‚’å–å¾—ã™ã‚‹
  - eks-configuration.ymlã‚’ä½œã£ã¦EKSã®è¨­å®šå‡¦ç†ã‚’å®Ÿè¡Œ EKSã¯ã‚ˆãåˆ†ã‹ã‚‰ã‚“ã®ã§PASS
  - aws-auth-cm.ymlã‚’ä½œã£ã¦èªè¨¼å‡¦ç†ã‚’å®Ÿè¡Œ EKSã¯ã‚ˆãåˆ†ã‹ã‚‰ã‚“ã®ã§PASS

- build-containers
  - cfn-output.jsonã‹ã‚‰CRYSTAL_ECR_REPO,NODEJS_ECR_REPOã‚’å–å¾—
  - docker buildã—ã¦ãƒªãƒã‚¸ãƒˆãƒªã«PUSH

- create-ecs-service
  - cfn-output.jsonã‹ã‚‰CLUSTER,TASK_DEF,TARGET_GROUP,SUBNET_ONE,SUBNET_TWO,SUBNET_THREE,SECURITY_GROUPã‚’å–å¾—
  - aws cliã§ECSã®ã‚µãƒ¼ãƒ“ã‚¹ä½œæˆã‚’è¡Œã†



## 11.
```
~/environment/scripts/bootstrap
```
**æ„å›³ï¼æ„å‘³**
10ã§ä½œæˆã—ãŸbootstrapã‚’å®Ÿè¡Œ
**ERROR**
```
Error: timed out (after 25m0s) waiting for at least 3 nodes to join the cluster and become ready in "appmesh-workshop-ng"
```
ã“ã‚ŒãŒç†ç”±ãªã®ã‹ã€ã“ã‚Œä»¥é™ã§ã‚‚ã‚¨ãƒ©ãƒ¼ã‚’åãã®ã§ã€å…ˆé€±ã®åœŸæ›œæ—¥ã¨åˆã‚ã›ã¦ï¼’å›žç›®ã®ä¸­æ–­ã€‚
ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¤‰ãˆã¦ã‚„ã‚‹ã‹ã€‚