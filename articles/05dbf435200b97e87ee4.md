---
title: "ã€Amazon Athena/Apache Icebergã€‘AWSã®åŸºç¤ã‚’å­¦ã¼ã†"
emoji: "ğŸš´ğŸ»â€â™€ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws","æ„Ÿæƒ³"]
published: true
---
# æ¦‚è¦
ã€ŒAWSã®åŸºç¤ã‚’å­¦ã¼ã†ã€ã§â€ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹å¼·åŒ–æœˆé–“ Athena ACID ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ + Icerbergâ€ã®ãƒãƒ³ã‚ºã‚ªãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã«å‚åŠ ã—ãŸæ„Ÿæƒ³ãƒšãƒ¼ã‚¸ã§ã™ã€‚

# ã€ŒAWS ã‚¨ãƒãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã‚·ãƒªãƒ¼ã‚ºã€€AWSã®åŸºç¤ã‚’å­¦ã¼ã†ã€ã¨ã¯
[AWS ã‚¨ãƒãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã‚·ãƒªãƒ¼ã‚ºã€€AWSã®åŸºç¤ã‚’å­¦ã¼ã†](https://awsbasics.connpass.com)

ä»¥ä¸‹ã€Connpassãƒšãƒ¼ã‚¸ã‚ˆã‚Šå¼•ç”¨

>  Amazon Web Services (AWS)ã¯ç¾åœ¨200ã‚’è¶…ãˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ã€æ—¥ã€…ã‚µãƒ¼ãƒ“ã‚¹ã®æ‹¡å……ã‚’ç¶šã‘ã¦ã„ã¾ã™ã€‚
> ã“ã®AWS ã‚¨ãƒãƒ³ãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã‚·ãƒªãƒ¼ã‚ºã§ã¯é€±æ¬¡ã§AWSã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã²ã¨ã¤ã¥ã¤å–ã‚Šä¸Šã’ãªãŒã‚‰ãã®åŸºç¤ã‚’èª¬æ˜ã—ã¦ã„ã åˆå¿ƒè€…ã€ä¸­ç´šè€…ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã—ãŸè¬›åº§ã§ã™ã€‚åˆå¾Œã®ä»•äº‹å‰ã«ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã‚’ä¸€ç·’ã«ã—ã¾ã›ã‚“ã‹ï¼Ÿ
> æ³¨æ„ç‚¹ ç™»å£‡è€…ã«ã‚ˆã‚‹ç™ºè¡¨å†…å®¹ã¯ã‚¢ãƒã‚¾ãƒ³ ã‚¦ã‚§ãƒ– ã‚µãƒ¼ãƒ“ã‚¹ ã‚¸ãƒ£ãƒ‘ãƒ³ã¨ã—ã¦ä¸»å‚¬ã—ã¦ã„ã‚‹ã‚‚ã®ã§ã¯ãªãã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ´»å‹•ã®ä¸€ç’°ã¨ã—ã¦å‹‰å¼·ä¼šã®ä¸»å‚¬ã‚’è¡Œã£ã¦ã„ã‚‹ã‚‚ã®ã§ã™ã€‚

æ¯é€±ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

---
# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰èª¿æŸ»
## Amazon Athena
https://aws.amazon.com/jp/athena/

Amazon Athena ã¯ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¯ã‚¨ãƒªã‚µãƒ¼ãƒ“ã‚¹ã§ã€Amazon S3 å†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¨™æº– SQL ã‚’ä½¿ç”¨ã—ã¦ç°¡å˜ã«åˆ†æã§ãã¾ã™ã€‚Athena ã¯ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãªã®ã§ã€ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®ç®¡ç†ã¯ä¸è¦ã§ã™ã€‚å®Ÿè¡Œã—ãŸã‚¯ã‚¨ãƒªã«å¯¾ã—ã¦ã®ã¿æ–™é‡‘ãŒç™ºç”Ÿã—ã¾ã™ã€‚

Athena ã¯ç°¡å˜ã«ä½¿ãˆã¾ã™ã€‚æ“ä½œã¯ç°¡å˜ã§ã€Amazon S3 ã«ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æŒ‡å®šã—ã€ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã€æ¨™æº–çš„ãª SQL ã‚’ä½¿ç”¨ã—ã¦ã‚¯ã‚¨ãƒªã®å®Ÿè¡Œã‚’é–‹å§‹ã™ã‚‹ã ã‘ã§ã™ã€‚å¤šãã®å ´åˆã€æ•°ç§’ã§çµæœãŒå‡ºã¦ãã¾ã™ã€‚Athena ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€åˆ†æç”¨ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã™ã‚‹ãŸã‚ã®è¤‡é›‘ãª ETL ã‚¸ãƒ§ãƒ–ã¯ä¸è¦ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã€èª°ã§ã‚‚ SQL ã®ã‚¹ã‚­ãƒ«ã‚’ä½¿ã£ã¦ã€å¤§å‹ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ã™ã°ã‚„ãã€ç°¡å˜ã«åˆ†æã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

Athena ã¯åˆæœŸçŠ¶æ…‹ã§ AWS Glueãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã¨çµ±åˆã•ã‚Œã¦ãŠã‚Šã€ã•ã¾ã–ã¾ãªã‚µãƒ¼ãƒ“ã‚¹ã«ã‚ãŸã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®çµ±åˆãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã§ãã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ã‚¹ã‚­ãƒ¼ãƒã®è§£æã€æ–°è¦ãŠã‚ˆã³ä¿®æ­£ã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã¨ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³å®šç¾©ã®ã‚«ã‚¿ãƒ­ã‚°ã¸ã®å…¥åŠ›ã€ã‚¹ã‚­ãƒ¼ãƒã®ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ä¿æŒãŒå¯èƒ½ã§ã™ã€‚


## Apache Iceberg
https://iceberg.apache.org/

Iceberg is a high-performance format for huge analytic tables. Iceberg brings the reliability and simplicity of SQL tables to big data, while making it possible for engines like Spark, Trino, Flink, Presto, and Hive to safely work with the same tables, at the same time.

Icebergã¯ã€å·¨å¤§ãªåˆ†æãƒ†ãƒ¼ãƒ–ãƒ«ã®ãŸã‚ã®é«˜æ€§èƒ½ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã™ã€‚Icebergã¯SQLãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¿¡é ¼æ€§ã¨ã‚·ãƒ³ãƒ—ãƒ«ã•ã‚’ãƒ“ãƒƒã‚°ãƒ‡ãƒ¼ã‚¿ã«ã‚‚ãŸã‚‰ã—ã€Sparkã€Trinoã€Flinkã€Prestoã€Hiveãªã©ã®ã‚¨ãƒ³ã‚¸ãƒ³ãŒåŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’åŒæ™‚ã«å®‰å…¨ã«æ‰±ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

## Athena ACID ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ä½¿ç”¨
https://docs.aws.amazon.com/ja_jp/athena/latest/ug/acid-transactions.html

ACID ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ã«å¯¾ã™ã‚‹ã‚¯ã‚¨ãƒªã«ãŠã„ã¦èª­ã¿å–ã‚Šã®ä¸€è²«æ€§ã‚’ç¶­æŒã™ã‚‹ã“ã¨ã§ã€æ—¢å­˜ã®ã‚¯ã‚¨ãƒªã‚’åˆ†é›¢ã—ãªãŒã‚‰ã€è¤‡æ•°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒˆãƒŸãƒƒã‚¯ãªæ–¹æ³•ã§ Amazon S3 ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åŒæ™‚ã«ç¢ºå®Ÿã«è¿½åŠ ãŠã‚ˆã³å‰Šé™¤ã§ãã¾ã™ã€‚Athena ACID ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€Athena SQL ãƒ‡ãƒ¼ã‚¿æ“ä½œè¨€èª (DML) ã«ã‚ˆã‚‹æ›¸ãè¾¼ã¿ã€å‰Šé™¤ã€æ›´æ–°ã€ãŠã‚ˆã³ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒ™ãƒ«ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã®ã€å˜ä¸€ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚µãƒãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚

# ç¢ºèª
## Create Table
Athenaã¯S3ã‚’AWS Glueã§ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã€ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã‚’ä½œæˆã—ã¾ã™ã€‚
ã—ã‹ã—å…ƒãƒ‡ãƒ¼ã‚¿ãŒãªã„çŠ¶æ…‹ã§ã‚‚DMLæ“ä½œãŒå¯èƒ½ã«ãªã£ãŸã®ã§ã€SELECTãƒ»INSERTãƒ»DELETEãƒ»UPDATEãŒã§ãã‚‹æ§˜ã«ãªã‚Šã¾ã—ãŸã€‚

ä»¥ä¸‹ã€æ‰‹é †æ›¸ã«ã‚ã£ãŸCREATE TABLE
```
CREATE TABLE iceberg_table (
  id int,
  data string,
  category string) 
PARTITIONED BY (category, bucket(16,id)) 
LOCATION 's3://<mybucket>/iceberg_table/' 
TBLPROPERTIES (
  'table_type'='ICEBERG',
  'format'='parquet',
  'write_target_data_file_size_bytes'='536870912' 
)
```
`TBLPROPERTIES`ã®èª¬æ˜ã‚’è¦‹ã‚ˆã†ã¨æ€ã£ã¦ã€Athenaã®Create Tableãƒšãƒ¼ã‚¸ã‚’è¦‹ã¦ã„ã‚“ã§ã™ãŒã€ãªã„ã‚“ã§ã™ã‚ˆã­ã€‚
https://docs.aws.amazon.com/athena/latest/ug/create-table.html

èª¿ã¹ã¦ã¿ã‚‹ã¨åˆ¥ãƒšãƒ¼ã‚¸ã«ã‚ã‚Šã¾ã—ãŸã€‚
`Iceberg ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ`ã£ã¦åˆ¥ãƒšãƒ¼ã‚¸ã«ä½œã‚‹ã®æ­¢ã‚ã¦w
ICEBERGã®ä½œæˆã®å ´åˆã»ã¼å¤‰æ›´ã¯ã›ãšã«è¡Œã‘ã‚‹ã‹ãªã€‚
https://docs.aws.amazon.com/athena/latest/ug/querying-iceberg-creating-tables.html

## Create Tableå¾Œã®S3
s3://<mybucket>/iceberg_table/metadata/é…ä¸‹ã«metadataã‚’æ•´ç†ã—ãŸjsonãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™
ã“ã‚“ãªä¸­èº«
```
{
  "format-version" : 2,
  "table-uuid" : "d2a6031b-a0f8-47f9-8c5b-b7880b26330e",
  "location" : "s3://20220416-handson/iceberg_table",
  "last-sequence-number" : 0,
  "last-updated-ms" : 1650111337657,
  "last-column-id" : 3,
  "current-schema-id" : 0,
  "schemas" : [ {
    "type" : "struct",
    "schema-id" : 0,
    "fields" : [ {
      "id" : 1,
      "name" : "id",
      "required" : false,
      "type" : "int"
    }, {
      "id" : 2,
      "name" : "data",
      "required" : false,
      "type" : "string"
    }, {
      "id" : 3,
      "name" : "category",
      "required" : false,
      "type" : "string"
    } ]
  } ],
  "default-spec-id" : 0,
  "partition-specs" : [ {
    "spec-id" : 0,
    "fields" : [ {
      "name" : "category",
      "transform" : "identity",
      "source-id" : 3,
      "field-id" : 1000
    }, {
      "name" : "id_bucket",
      "transform" : "bucket[16]",
      "source-id" : 1,
      "field-id" : 1001
    } ]
  } ],
  "last-partition-id" : 1001,
  "default-sort-order-id" : 0,
  "sort-orders" : [ {
    "order-id" : 0,
    "fields" : [ ]
  } ],
  "properties" : {
    "write.format.default" : "parquet",
    "write.target-file-size-bytes" : "536870912",
    "write.object-storage.enabled" : "true",
    "write.object-storage.path" : "s3://20220416-handson/iceberg_table/data"
  },
  "current-snapshot-id" : -1,
  "snapshots" : [ ],
  "snapshot-log" : [ ],
  "metadata-log" : [ ]
}
```

## Insertå®Ÿæ–½
```
INSERT INTO default.iceberg_table (id, data, category) values(1, 'Amazon', 'Athena');
INSERT INTO default.iceberg_table (id, data, category) values(2, 'Amazon', 'Redshift');
```

## Insertå¾Œã®Sï¼“
s3://<mybucket>/iceberg_table/metadata/é…ä¸‹ã«metadataã‚’æ•´ç†ã—ãŸjsonã¨avroãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™
é¸æŠã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒInsertã§ä½œæˆã•ã‚ŒãŸjsonã¨avro
![](https://storage.googleapis.com/zenn-user-upload/77240aae9cae-20220416.png)


jsonãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã¯ä»¥ä¸‹
```
{
  "format-version" : 2,
  "table-uuid" : "d2a6031b-a0f8-47f9-8c5b-b7880b26330e",
  "location" : "s3://20220416-handson/iceberg_table",
  "last-sequence-number" : 1,
  "last-updated-ms" : 1650111563910,
  "last-column-id" : 3,
  "current-schema-id" : 0,
  "schemas" : [ {
    "type" : "struct",
    "schema-id" : 0,
    "fields" : [ {
      "id" : 1,
      "name" : "id",
      "required" : false,
      "type" : "int"
    }, {
      "id" : 2,
      "name" : "data",
      "required" : false,
      "type" : "string"
    }, {
      "id" : 3,
      "name" : "category",
      "required" : false,
      "type" : "string"
    } ]
  } ],
  "default-spec-id" : 0,
  "partition-specs" : [ {
    "spec-id" : 0,
    "fields" : [ {
      "name" : "category",
      "transform" : "identity",
      "source-id" : 3,
      "field-id" : 1000
    }, {
      "name" : "id_bucket",
      "transform" : "bucket[16]",
      "source-id" : 1,
      "field-id" : 1001
    } ]
  } ],
  "last-partition-id" : 1001,
  "default-sort-order-id" : 0,
  "sort-orders" : [ {
    "order-id" : 0,
    "fields" : [ ]
  } ],
  "properties" : {
    "write.target-file-size-bytes" : "536870912",
    "write.format.default" : "parquet",
    "write.object-storage.enabled" : "true",
    "write.object-storage.path" : "s3://20220416-handson/iceberg_table/data"
  },
  "current-snapshot-id" : 5290151603716099131,
  "snapshots" : [ {
    "sequence-number" : 1,
    "snapshot-id" : 5290151603716099131,
    "timestamp-ms" : 1650111563910,
    "summary" : {
      "operation" : "append",
      "added-data-files" : "1",
      "added-records" : "1",
      "added-files-size" : "433",
      "changed-partition-count" : "1",
      "total-records" : "1",
      "total-files-size" : "433",
      "total-data-files" : "1",
      "total-delete-files" : "0",
      "total-position-deletes" : "0",
      "total-equality-deletes" : "0"
    },
    "manifest-list" : "s3://20220416-handson/iceberg_table/metadata/snap-5290151603716099131-1-c1e8ab68-42c1-4abb-a918-612091f456bb.avro",
    "schema-id" : 0
  } ],
  "snapshot-log" : [ {
    "timestamp-ms" : 1650111563910,
    "snapshot-id" : 5290151603716099131
  } ],
  "metadata-log" : [ {
    "timestamp-ms" : 1650111337657,
    "metadata-file" : "s3://20220416-handson/iceberg_table/metadata/00000-bc537eff-1a8b-4646-9d19-3e630b6abe1d.metadata.json"
  } ]
}
```

## Apache Avroã£ã¦ãªã«ï¼Ÿ
https://avro.apache.org/docs/current/
Apache Avroâ„¢ ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

Avro ã¯ä»¥ä¸‹ã‚’æä¾›ã—ã¾ã™ã€‚
- è±Šå¯Œãªãƒ‡ãƒ¼ã‚¿æ§‹é€ 
- ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã§é«˜é€Ÿãªãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿å½¢å¼
- æ°¸ç¶šçš„ãªãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠãƒ•ã‚¡ã‚¤ãƒ«ã€‚
- ãƒªãƒ¢ãƒ¼ãƒˆãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã‚³ãƒ¼ãƒ«ï¼ˆRPCï¼‰ã€‚
- å‹•çš„è¨€èªã¨ã®çµ±åˆãŒç°¡å˜ ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿æ›¸ãã‚„RPCãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ä½¿ç”¨ãƒ»å®Ÿè£…ã«ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æœ€é©åŒ–ã§ã‚ã‚Šã€é™çš„å‹ä»˜ã‘è¨€èªã«å¯¾ã—ã¦ã®ã¿å®Ÿè£…ã™ã‚‹ä¾¡å€¤ãŒã‚ã‚‹ã€‚

Avroã¯ã‚¹ã‚­ãƒ¼ãƒã«ä¾å­˜ã—ã¦ã„ã¾ã™ã€‚Avro ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€éš›ã«ã¯ã€æ›¸ãè¾¼ã¿æ™‚ã«ä½¿ç”¨ã—ãŸã‚¹ã‚­ãƒ¼ãƒãŒå¸¸ã«å­˜åœ¨ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å€¤ã”ã¨ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãªã—ã«å„ãƒ‡ãƒ¼ã‚¿ãƒ ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é«˜é€Ÿã‹ã¤å°è¦æ¨¡ã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã€ãƒ‡ãƒ¼ã‚¿ãŒã‚¹ã‚­ãƒ¼ãƒã¨ã¨ã‚‚ã«å®Œå…¨ã«è‡ªå·±è¨˜è¿°ã•ã‚Œã‚‹ãŸã‚ã€å‹•çš„ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆè¨€èªã§ã®ä½¿ç”¨ã‚‚å®¹æ˜“ã§ã™ã€‚

Avro ãƒ‡ãƒ¼ã‚¿ãŒãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã•ã‚Œã‚‹ã¨ã€ãã®ã‚¹ã‚­ãƒ¼ãƒã‚‚ä¸€ç·’ã«ä¿å­˜ã•ã‚Œã‚‹ãŸã‚ã€ã©ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã‚‚å¾Œã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒç•°ãªã‚‹ã‚¹ã‚­ãƒ¼ãƒã‚’æœŸå¾…ã—ã¦ã‚‚ã€ä¸¡æ–¹ã®ã‚¹ã‚­ãƒ¼ãƒãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€ç°¡å˜ã«è§£æ±ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

Avro ãŒ RPC ã§ä½¿ç”¨ã•ã‚Œã‚‹å ´åˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼ã¯æ¥ç¶šã®ãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ã§ã‚¹ã‚­ãƒ¼ãƒã‚’äº¤æ›ã—ã¾ã™ã€‚(ã“ã‚Œã¯æœ€é©åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã€ã»ã¨ã‚“ã©ã®å‘¼ã³å‡ºã—ã§å®Ÿéš›ã«ã¯ã‚¹ã‚­ãƒ¼ãƒã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“)ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼ã®ä¸¡æ–¹ãŒç›¸æ‰‹ã®å®Œå…¨ãªã‚¹ã‚­ãƒ¼ãƒã‚’æŒã£ã¦ã„ã‚‹ã®ã§ã€åŒã˜åå‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€æ¬ æãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€ä½™åˆ†ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã©ã®å¯¾å¿œã‚’ã™ã¹ã¦ç°¡å˜ã«è§£æ±ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

Avroã‚¹ã‚­ãƒ¼ãƒã¯JSONã§å®šç¾©ã•ã‚Œã¾ã™ã€‚ã“ã®ãŸã‚ã€JSON ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã™ã§ã«æŒã£ã¦ã„ã‚‹è¨€èªã§ã®å®Ÿè£…ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚

## data
å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®æ§˜ãªPATHã§æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™

s3://<mybucket>/iceberg_table/data/292fd851//iceberg_table/category=Redshift/id_bucket=4/83425592-5b22-41c8-887c-49db9d468f4d.gz.parquet

ãˆã€é•·ã„ã€‚ã€‚ã€‚


ãªãŠã€Apache Parquetãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§S3 Selectã™ã‚‹ã¨ä»¥ä¸‹çµæœãŒè¿”ã£ã¦ãã¾ã™
```
2,Amazon,Redshift
```

# ç–‘å•
Athenaã®èª¬æ˜ã«ã‚ã‚‹ã‚ˆã†ã«ã€ŒAmazon S3 å†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¨™æº– SQL ã‚’ä½¿ç”¨ã—ã¦ç°¡å˜ã«åˆ†æã§ãã¾ã™ã€ãŒAthenaã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ã‚’Athenaã§Insertã™ã‚‹ã“ã¨ãŒãŠä»•äº‹ã§ã¯ãªã„ã§ã™ã€‚

s3://<mybucket>/iceberg_table/data/292fd851//iceberg_table/category=Redshift/id_bucket=4/83425592-5b22-41c8-887c-49db9d468f4d.gz.parquet

ã•ã¦ã€ã“ã®éšå±¤æ§‹é€ ã«å¤‰æ›ã™ã‚‹ã®ã¯Glueã§ã‚„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿï¼Ÿ EMRã®çµæœãªã®ã§ã—ã‚‡ã†ã‹ï¼Ÿï¼Ÿ
WorkShopã‚’ã‚„ã‚Œã°ç–‘å•è§£æ±ºã™ã‚‹ã‹ãªï¼Ÿã¨æ€ã„ãªãŒã‚‰ä»Šæ—¥ã¯ã“ã“ã¾ã§ã€‚

# è³‡æ–™
## ãƒãƒ³ã‚ºã‚ªãƒ³æ‰‹é †æ›¸
https://github.com/harunobukameda/Amazon-Athena-ACID-transcation

## Apache Iceberg
https://iceberg.apache.org/

## Apache Avro
https://avro.apache.org/docs/current/

## Amazon Athena Workshop
https://catalog.us-east-1.prod.workshops.aws/workshops/9981f1a1-abdc-49b5-8387-cb01d238bb78/en-US