---
title: "ã€AWS CodeDeployã€‘AWSã®åŸºç¤ã‚’å­¦ã¼ã† ç¬¬å…­åå›"
emoji: "ğŸš´ğŸ»â€â™€ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws","åº§å­¦","æ„Ÿæƒ³"]
published: true
---
å®¿é¡Œæœªæå‡ºãŒæºœã¾ã£ã¦ã„ã‚‹ï¼ï¼

# æ¦‚è¦
ã€ŒAWS ã‚¨ãƒãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã‚·ãƒªãƒ¼ã‚ºã€€AWSã®åŸºç¤ã‚’å­¦ã¼ã†ã€ã§â€AWS CodeDeployã®ãŠã•ã‚‰ã„â€ã®ã‚¤ãƒ™ãƒ³ãƒˆã«å‚åŠ ã—ãŸæ„Ÿæƒ³ãƒšãƒ¼ã‚¸ã§ã™ã€‚

# ã€ŒAWS ã‚¨ãƒãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã‚·ãƒªãƒ¼ã‚ºã€€AWSã®åŸºç¤ã‚’å­¦ã¼ã†ã€ã¨ã¯
[AWS ã‚¨ãƒãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆã‚·ãƒªãƒ¼ã‚ºã€€AWSã®åŸºç¤ã‚’å­¦ã¼ã†](https://awsbasics.connpass.com)

ä»¥ä¸‹ã€Connpassãƒšãƒ¼ã‚¸ã‚ˆã‚Šå¼•ç”¨

> Amazon Web Services (AWS)ã¯ç¾åœ¨200ã‚’è¶…ãˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ã€æ—¥ã€…ã‚µãƒ¼ãƒ“ã‚¹ã®æ‹¡å……ã‚’ç¶šã‘ã¦ã„ã¾ã™ã€‚
> ã“ã®AWS ã‚¨ãƒãƒ³ã‚¸ã‚§ãƒªã‚¹ãƒˆ ã‚·ãƒªãƒ¼ã‚ºã§ã¯é€±æ¬¡ã§AWSã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã²ã¨ã¤ã¥ã¤å–ã‚Šä¸Šã’ãªãŒã‚‰ãã®åŸºç¤ã‚’èª¬æ˜ã—ã¦ã„ã åˆå¿ƒè€…ã€ä¸­ç´šè€…ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã—ãŸè¬›åº§ã§ã™ã€‚åˆå¾Œã®ä»•äº‹å‰ã«ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã‚’ä¸€ç·’ã«ã—ã¾ã›ã‚“ã‹ï¼Ÿ
æ¯é€±ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

# æ•´ç†
## CodeDeployï¼Ÿ
https://aws.amazon.com/jp/codebuild/faqs/?nc=sn&loc=5
> AWS CodeBuild ã¯ã€ã‚¯ãƒ©ã‚¦ãƒ‰å†…ã®å®Œå…¨ãƒãƒãƒ¼ã‚¸ãƒ‰å‹ã®ç¶™ç¶šçš„çµ±åˆã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚CodeBuild ã§ã¯ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã€ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã€ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ç”Ÿæˆã‚’è¡Œãˆã¾ã™ã€‚CodeBuild ã§ã¯è‡ªåˆ†ã®ãƒ“ãƒ«ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã€ç®¡ç†ã€ã‚¹ã‚±ãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚CodeBuild ãŒè‡ªå‹•çš„ã«ã‚¹ã‚±ãƒ¼ãƒ«ã—è¤‡æ•°ã®ãƒ“ãƒ«ãƒ‰ã‚’åŒæ™‚ã«å‡¦ç†ã™ã‚‹ãŸã‚ã€ãƒ“ãƒ«ãƒ‰ã¯ã‚­ãƒ¥ãƒ¼ã§å¾…æ©Ÿã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚CodeBuild ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ¸ˆã¿ã®ãƒ“ãƒ«ãƒ‰ç’°å¢ƒã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€ã”è‡ªåˆ†ã®ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ“ãƒ«ãƒ‰ç’°å¢ƒã‚’ä½œæˆã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã™ãã«é–‹å§‹ã§ãã¾ã™ã€‚CodeBuild ã®èª²é‡‘ã¯ã€åˆ†å˜ä½ã§ã™ã€‚

## ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
![](https://storage.googleapis.com/zenn-user-upload/6973642050cc73c19015b483.png)
ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¨ã—ã¦ã¯
- EC2ï¼ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹
- AWS Lambda
- Amazon ECS
ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

## EC2ã§è©¦ã™
### æ§‹æˆå›³
![](https://storage.googleapis.com/zenn-user-upload/2d23aa237040ba5cf9400602.png)

### EC2èµ·å‹•æ™‚ã®UserData
ã‚„ã‚ŠãŸã„ã®ã¯ã€httpdã¨codedeploy-agentã‚’å…¥ã‚Œã‚‹äº‹
```
#!/bin/bash
sudo yum update -y
sudo yum install -y httpd
sudo systemctl start httpd
sudo echo `hostname`+ver.1 > /var/www/html/index.html
sudo yum install -y ruby
sudo yum install -y wget
cd /home/ec2-user
wget https://aws-codedeploy-ap-northeast-1.s3.ap-northeast-1.amazonaws.com/latest/install
chmod +x ./install
sudo ./install auto
sudo service codedeploy-agent status
```

### Curlã§ALBçµŒç”±ã¨EC2ç›´æ¥ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹
#### å®Ÿè¡Œcmd
```
while true
do
echo #########################
date
echo ### ALB ###
curl CodeDeploy-589250730.ap-northeast-1.elb.amazonaws.com;
echo ### IP143 ###
curl ec2-13-231-158-143.ap-northeast-1.compute.amazonaws.com;
echo ### IP162 ###
curl ec2-54-178-36-162.ap-northeast-1.compute.amazonaws.com;
echo ### IP74 ###
curl ec2-52-196-3-74.ap-northeast-1.compute.amazonaws.com;
echo ### IP243 ###
curl ec2-13-115-218-243.ap-northeast-1.compute.amazonaws.com;
sleep 5
done
```

#### å®Ÿè¡Œçµæœ
ALBã€ãŠå‘¼ã³EC2ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã“ã¨ã‚’ç¢ºèª
```
#########################
2021å¹´ 10æœˆ16æ—¥ åœŸæ›œæ—¥ 22æ™‚06åˆ†33ç§’ JST
### ALB ###
<h1>Ver1</h1>
### IP143 ###
<h1>Ver1</h1>
### IP162 ###
<h1>Ver1</h1>
### IP74 ###
<h1>Ver1</h1>
### IP243 ###
<h1>Ver1</h1>
```

### ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿæ–½ï¼‘
#### ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚¤ãƒ—
ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹
#### ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š
CodeDeployDefault.AllAtOnce
#### çµæœ
æµã‚Œã¨ã—ã¦ã¯
- ALBã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒå¤–ã‚Œã‚‹
- EC2ãŒå…¥ã‚Œæ›¿ã‚ã‚‹
- ALBãŒå†æ¥ç¶šã•ã‚Œã‚‹
```
#########################
2021å¹´ 10æœˆ17æ—¥ æ—¥æ›œæ—¥ 00æ™‚32åˆ†43ç§’ JST
### ALB ###
<h1>Ver1</h1>
### IP143 ###
<h1>Ver1</h1>
### IP162 ###
<h1>Ver1</h1>
### IP74 ###
<h1>Ver1</h1>
### IP243 ###
<h1>Ver1</h1>
#########################
2021å¹´ 10æœˆ17æ—¥ æ—¥æ›œæ—¥ 00æ™‚32åˆ†48ç§’ JST
### ALB ###
<html>
<head><title>503 Service Temporarily Unavailable</title></head>
<body>
<center><h1>503 Service Temporarily Unavailable</h1></center>
</body>
</html>
### IP143 ###
<h1>Ver1</h1>
### IP162 ###
<h1>Ver1</h1>
### IP74 ###
<h1>Ver1</h1>
### IP243 ###
<h1>Ver1</h1>
#########################
2021å¹´ 10æœˆ17æ—¥ æ—¥æ›œæ—¥ 00æ™‚32åˆ†53ç§’ JST
### ALB ###
<html>
<head><title>503 Service Temporarily Unavailable</title></head>
<body>
<center><h1>503 Service Temporarily Unavailable</h1></center>
</body>
</html>
### IP143 ###
<h1>Ver2!!</h1>
### IP162 ###
<h1>Ver2!!</h1>
### IP74 ###
<h1>Ver2!!</h1>
### IP243 ###
<h1>Ver2!!</h1>
#########################
2021å¹´ 10æœˆ17æ—¥ æ—¥æ›œæ—¥ 00æ™‚33åˆ†04ç§’ JST
### ALB ###
<h1>Ver2!!</h1>
### IP143 ###
<h1>Ver2!!</h1>
### IP162 ###
<h1>Ver2!!</h1>
### IP74 ###
<h1>Ver2!!</h1>
### IP243 ###
<h1>Ver2!!</h1>
```


### ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿæ–½2
#### ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚¤ãƒ—
ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹
#### ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š
CodeDeployDefault.HalfAtOnce
#### çµæœ
æµã‚Œã¨ã—ã¦ã¯
- ALBãŒæ—§Verã«æµã‚Œã¦ã„ã‚‹é–“ã§ã€åŠåˆ†ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹
- ALBãŒæ–°Verã«æµã‚Œã¦ã„ã‚‹é–“ã§ã€æ®‹ã‚ŠåŠåˆ†ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã€‚
- ALBãŒå…¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ãªã‚‹ã€‚
```
#########################
2021å¹´ 10æœˆ17æ—¥ æ—¥æ›œæ—¥ 00æ™‚51åˆ†29ç§’ JST
### ALB ###
<h1>Ver3!!!</h1>
### IP143 ###
<h1>Ver3!!!</h1>
### IP162 ###
<h1>Ver3!!!</h1>
### IP74 ###
<h1>Ver3!!!</h1>
### IP243 ###
<h1>Ver3!!!</h1>
#########################
2021å¹´ 10æœˆ17æ—¥ æ—¥æ›œæ—¥ 00æ™‚51åˆ†35ç§’ JST
### ALB ###
<h1>Ver3!!!</h1>
### IP143 ###
<h1>Ver4!!!</h1>
### IP162 ###
<h1>Ver3!!!</h1>
### IP74 ###
<h1>Ver4!!!</h1>
### IP243 ###
<h1>Ver3!!!</h1>

(ç•¥)

#########################
2021å¹´ 10æœˆ17æ—¥ æ—¥æ›œæ—¥ 00æ™‚52åˆ†35ç§’ JST
### ALB ###
<h1>Ver4!!!</h1>
### IP143 ###
<h1>Ver4!!!</h1>
### IP162 ###
<h1>Ver3!!!</h1>
### IP74 ###
<h1>Ver4!!!</h1>
### IP243 ###
<h1>Ver3!!!</h1>

(ç•¥)

#########################
2021å¹´ 10æœˆ17æ—¥ æ—¥æ›œæ—¥ 00æ™‚53åˆ†37ç§’ JST
### ALB ###
<h1>Ver4!!!</h1>
### IP143 ###
<h1>Ver4!!!</h1>
### IP162 ###
<h1>Ver3!!!</h1>
### IP74 ###
<h1>Ver4!!!</h1>
### IP243 ###
<h1>Ver4!!!</h1>
```


### ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿæ–½ï¼“
#### ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚¤ãƒ—
Blue/Green
#### ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š
CodeDeployDefault.AllAtOnce
#### çµæœ
ã‚¨ãƒ©ãƒ¼ä¸­ã€‚
AutoScalingã‚’ã›ãšã«EC2ã‚’4å°æ§‹æˆã®ã¾ã¾ã§ã€Blue/GreenãŒã¡ã‚ƒã‚“ã¨ç†è§£ã§ãã¦ãªã„ã‹ã‚‚ã€‚
![](https://storage.googleapis.com/zenn-user-upload/bdb95992a977bde01a4bf0f1.png)
