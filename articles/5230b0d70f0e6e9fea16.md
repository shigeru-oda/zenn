---
title: "REST API ã®ç›¸äº’ TLS èªè¨¼ã‚’ã‚„ã‚‹ã€‚"
emoji: "ğŸš´ğŸ»â€â™€ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws","åº§å­¦"]
published: true
---
# æ¦‚è¦
REST API ã®ç›¸äº’ TLS èªè¨¼ã‚’å‹‰å¼·ã™ã‚‹ç‚ºã®è¨˜äº‹ã€API GATEWAYã§ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèªè¨¼ã‚’ã‚„ã‚ŠãŸã„ã€‚

# AWSè³‡æ–™
https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/rest-api-mutual-tls.html
https://repost.aws/ja/knowledge-center/api-gateway-tls-certificate

# ClassMethodè³‡æ–™
https://dev.classmethod.jp/articles/api-gateway-support-mutual-tls-auth/

# ã‚„ã£ã¦ã¿ã‚‹

## Cloud9ã§ã®ç’°å¢ƒä½œæˆ
ã¾ãšã¯ç’°å¢ƒæº–å‚™

### .pyenvã®è¨­å®š
```
# git clone
git clone https://github.com/pyenv/pyenv.git ~/.pyenv

# bash_profileã®ç·¨é›†
echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bash_profile
echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bash_profile
echo 'eval "$(pyenv init -)"' >> ~/.bash_profile

# bash_profileã®èª­ã¿è¾¼ã¿
source ~/.bash_profile

# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®Install
sudo yum -y update
sudo yum remove -y openssl-devel
sudo yum -y install gcc make patch zlib-devel bzip2 bzip2-devel readline-devel sqlite sqlite-devel tk-devel libffi-devel xz-devel openssl11 openssl11-devel

# Install 5åˆ†ç¨‹åº¦è¦ã—ã¾ã™
pyenv install 3.10.11

# Versionåˆ‡ã‚Šæ›¿ãˆ
pyenv global 3.10.11

# æœ€æ–°åŒ–å¾Œã®Versionç¢ºèª
python --version
```


### Pythonä»®æƒ³ç’°å¢ƒä½œæˆ

```
# ä»®æƒ³ç’°å¢ƒã®ä½œæˆ
python -m venv .venv

# ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ
source .venv/bin/activate
```


### AWS CLIæœ€æ–°åŒ–
```
# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã‚’DownLoad
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"

# è§£ç­”
unzip awscliv2.zip

# æœ€æ–°åŒ–
sudo ./aws/install --bin-dir /usr/local/bin --install-dir /usr/local/aws-cli --update

# ã‚´ãƒŸå‰Šé™¤
rm -rf aws awscliv2.zip 

# æœ€æ–°åŒ–å¾Œã®Versionç¢ºèª
aws --version
```

### AWS SAM CLI ã®æœ€æ–°åŒ–
```
# githubã‚ˆã‚Šã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã‚’DownLoad
wget https://github.com/aws/aws-sam-cli/releases/latest/download/aws-sam-cli-linux-x86_64.zip

# è§£ç­”
unzip aws-sam-cli-linux-x86_64.zip -d sam-installation

# æœ€æ–°åŒ–
sudo ./sam-installation/install --update

# ã‚´ãƒŸå‰Šé™¤
rm -rf aws-sam-cli-linux-x86_64.zip sam-installation

# æœ€æ–°åŒ–å¾Œã®Versionç¢ºèª
sam --version
```


## AWS SAMã§HelloWorldä½œæˆ
API Gatewayã¨Lambdaä½œæˆ

### SAMå®Ÿè¡Œ
```
# APPã®åˆæœŸåŒ–
cd ~/environment/
sam init

# é¸æŠè‚¢
- AWS Quick Start Templates
- Hello World Example
- N
- python3.10
- Zip
- N
- N
- rest-api-tls

# Build
cd ~/environment/rest-api-tls
sam build

# Deploy
cd ~/environment/rest-api-tls
sam deploy --guided

# é¸æŠè‚¢
åŸºæœ¬ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ`HelloWorldFunction may not have authorization defined, Is this okay? [y/N]`ã ã‘Y

# Deployä¸­
Deploy this changeset? [y/N]: Y
```

### HelloWorldApiã®å¤‰æ•°è¨­å®š

```
API_ENDPOINT="https://xxxxxx.execute-api.ap-northeast-1.amazonaws.com/Prod/hello/"
curl $API_ENDPOINT
```
{"message": "hello world"}ã¨ã„ã†æ–‡å­—ãŒå‡ºã‚Œã°OK


## ACMä½œæˆ

### å‰æ
Route53ä¸Šã«ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒã‚ã‚‹ã“ã¨ãŒå‰æ

### ACMã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆç™ºè¡Œ
```
aws acm request-certificate \
  --domain-name $SUB_DOMAIN \
  --validation-method DNS
```

### ACMã®ç”»é¢ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§Route53ã¸ãƒ¬ã‚³ãƒ¼ãƒ‰ç™»éŒ²ãŒå‡ºæ¥ã‚‹ç”»é¢ãŒã‚ã‚‹ã®ã§ã€å¾“ã†
![](https://storage.googleapis.com/zenn-user-upload/dc7a9c146040-20230520.png)

### API Gatewayã§ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ä½œæˆ
```
# ACMã®ARNå–å¾—
CertificateArn=$(aws acm list-certificates \
  --query "CertificateSummaryList[?DomainName==\`$SUB_DOMAIN\`].CertificateArn" \
  --output text);echo $CertificateArn

# API IDå–å¾—
ApiId=$(aws apigateway get-rest-apis \
  --query "items[?name==\`rest-api-tls\`].id" \
  --output text);echo $ApiId

# ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ä½œæˆ
aws apigatewayv2 create-domain-name \
  --domain-name $SUB_DOMAIN \
  --domain-name-configurations CertificateArn=$CertificateArn

# ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã«APIã‚’ç´ã¥ã‘ã‚‹ï¼ˆAPIãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰
aws apigatewayv2 create-api-mapping \
  --domain-name $SUB_DOMAIN \
  --api-id $ApiId \
  --stage Prod
```

## Route53ã§ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’Aãƒ¬ã‚³ãƒ¼ãƒ‰ã«ç™»éŒ²
ä¸Šè¿°ã®ACMè¨­å®šãŒé€šã‚‹ã¾ã§å°‘ã€…æ™‚é–“ãŒã‹ã‹ã‚‹ã‚ˆã†ã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/1b3ccb9be46c-20230520.png)


## ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã§API CALL
```
# å¤‰æ•°è¨­å®š
SUB_DOMAIN_API_ENDPOINT=https://$SUB_DOMAIN/hello
echo $SUB_DOMAIN_API_ENDPOINT

# ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã§API CALL
curl $SUB_DOMAIN_API_ENDPOINT
```
{"message": "hello world"}ã¨ã„ã†æ–‡å­—ãŒå‡ºã‚Œã°OK

## ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Api Gateway Endpointã‚’æ½°ã™
```
# ç„¡åŠ¹åŒ–
aws apigateway update-rest-api \
  --rest-api-id $ApiId \
  --patch-operations op=replace,path=/disableExecuteApiEndpoint,value='True'

# Deploy
aws apigateway create-deployment \
  --rest-api-id $ApiId \
  --stage-name Prod

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Api CALL
API_ENDPOINT="https://jyl2n5wj7h.execute-api.ap-northeast-1.amazonaws.com/"
curl $API_ENDPOINT
```
{"message":"Forbidden"} ã§ã‚ã‚Œã°OK





## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸
```
# ãƒ«ãƒ¼ãƒˆCAã®ç§˜å¯†éµ ã‚’ç”Ÿæˆã—ã¾ã™
openssl genrsa -out RootCA.key 4096

# è‡ªå·±ç½²åCAè¨¼æ˜æ›¸ ã‚’ç”Ÿæˆã—ã¾ã™
openssl req -new -x509 -days 3650 -key RootCA.key -out RootCA.pem

# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼ ã‚’ç”Ÿæˆã—ã¾ã™
openssl genrsa -out my_client.key 2048

# è¨¼æ˜æ›¸ç½²åè¦æ±‚ (CSR) ã‚’ç”Ÿæˆã—ã¾ã™
openssl req -new -key my_client.key -out my_client.csr

# CA ã‚’ä½¿ç”¨ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã«ç½²åã—ã¾ã™
openssl x509 -req -in my_client.csr -CA RootCA.pem -CAkey RootCA.key -set_serial 01 -out my_client.pem -days 3650 -sha256
```

## S3ã«CAè¨¼æ˜æ›¸ã‚’Up
```
# S3ä½œæˆï¼ˆS3ã®åå‰ã¯å„è‡ªã§å¤‰æ›´ï¼‰
aws s3 mb s3://rest-api-tls-shigeruoda-20230520

# S3ã«æ ¼ç´
aws s3 cp RootCA.pem s3://rest-api-tls-shigeruoda-20230520
```

# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã«ã‚ˆã‚‹èªè¨¼ã‚’æœ‰åŠ¹åŒ–
```
aws apigatewayv2 update-domain-name \
  --domain-name $SUB_DOMAIN \
  --domain-name-configurations CertificateArn=$CertificateArn \
  --mutual-tls-authentication TruststoreUri=s3://rest-api-tls-shigeruoda-20230520/RootCA.pem
```

# æ›´æ–°ã¾ã¡ã€‚
![](https://storage.googleapis.com/zenn-user-upload/c429584dc57c-20230520.png)
ã¡ã‚‡ã£ã¨å¾…æ©Ÿ


## ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³ã§API CALL(å¤±æ•—)
```
# ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã§API CALL
curl $SUB_DOMAIN_API_ENDPOINT
```
curl: (35) Recv failure: Connection reset by peer ã¨ã„ã†ã‚¨ãƒ©ãƒ¼

## ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã§API CALL(æˆåŠŸ)
```
curl $SUB_DOMAIN_API_ENDPOINT --key my_client.key --cert my_client.pem
```
{"message": "hello world"}ã¨ã„ã†æ–‡å­—ãŒå‡ºã‚Œã°OK